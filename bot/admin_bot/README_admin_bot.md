
# AdminBot

## Версия от 20.09.2024

## 1. Суть проекта

Проект **AdminBot** разработан для автоматизации процессов администрирования мероприятий. Бот обеспечивает удобное взаимодействие с клиентами через Telegram, позволяя организаторам управлять мероприятиями, просматривать проформы и отправлять уведомления пользователям.

Пользователи могут:
- Выбирать язык для удобного взаимодействия.
- Просматривать свои заказы и статус мероприятий.
- Получать уведомления и уточнения через бота.

Администраторы могут:
- Управлять проформами и статусами заказов.
- Осуществлять поиск и удаление клиентов через админ-панель.

Сервисная служба:
- Обеспечивает поддержку и выполнение задач, связанных с функционалом проекта.
- Осуществляет управление техническими аспектами работы бота.


## 2. Файловая структура

Проект **AdminBot** организован по модульному принципу, что обеспечивает удобство поддержки и масштабирования. 

### Основные файлы и их назначения:

- `main.py`: Основной файл, который управляет запуском бота и его основными функциями.
- `config.py`: Содержит конфигурационные данные, такие как токены и параметры подключения к базе данных.
- `constants.py`: Хранит константы, например, статусы заказов и заголовки для различных шагов взаимодействия с пользователем.
- `translations.py`: Модуль для работы с переводами текстов сообщений и кнопок на разные языки.
- `helpers/`: Содержит вспомогательные модули, такие как функции для работы с календарем (`calendar_helpers.py`) и базой данных (`database_helpers.py`).
- `keyboards/`: Модуль для создания интерактивных клавиатур, используемых в боте.
- `scenarios/`: Логика взаимодействия с пользователями и администраторами, включая сценарии для различных ролей (администратор, пользователь, сервисная служба).

### Структура директорий и файлов проекта:

```plaintext
AdminBot/
│
├── helpers/                            # Вспомогательные функции и логи
│   ├── logs/
│   │   └── admin_bot.log               # Лог-файл для записей событий
│   ├── __init__.py
│   ├── calendar_helpers.py             # Функции для работы с календарем и датами
│   └── database_helpers.py             # Функции для работы с базой данных
│
├── keyboards/                          # Модули для создания клавиатур
│   ├── __init__.py
│   └── admin_keyboards.py              # Клавиатуры для взаимодействия с пользователями и администраторами
│
├── scenarios/                          # Логика взаимодействия с пользователями
│   ├── __init__.py
│   ├── admin_scenario.py               # Логика взаимодействия с администраторами
│   ├── service_scenario.py             # Логика для сервисной службы
│   └── user_scenario.py                # Логика для взаимодействия с пользователями
│
├── __init__.py
├── config.py                           # Конфигурационные переменные для базы данных и бота
├── constants.py                        # Основные константы, используемые в проекте (например, статусы заказов)
├── database_logger.py                  # Логирование запросов к базе данных
├── helpers.py                          # Общие вспомогательные функции
├── main.py                             # Основной файл, запускающий бота
├── README_admin_bot.md                 # Документация проекта (находится в процессе редактирования)
└── translations.py                     # Модуль для хранения переводов на разные языки


## 3. Архитектура

### 3.1 Принцип модульности

Принцип модульности используется для разделения функций бота на отдельные модули, каждый из которых выполняет свою задачу:

- **Основные модули** обрабатывают взаимодействие с пользователем, включая выбор языка, просмотр проформ и отправку сообщений.
- **Вспомогательные модули** управляют базой данных, логированием и конфигурацией.

### 3.2 Перечень модулей с их названиями

1. **Модуль 1** (Основной)
   - Название: `language_selection`
   - Описание: Выбор языка пользователем.
   - Функции: `language_selection_keyboard()`

2. **Модуль 2** (Основной)
   - Название: `greeting`
   - Описание: Приветствие пользователя и инициализация данных пользователя.
   - Функции: `start()`

3. **Модуль 3** (Основной)
   - Название: `proforma_handling`
   - Описание: Генерация и отправка проформ пользователям.
   - Функции: `get_full_proforma()`, `send_proforma_to_user()`

4. **Модуль 4** (Вспомогательный)
   - Название: `database_helpers`
   - Описание: Вспомогательные функции для работы с базой данных.
   - Функции: `get_user_data()`, `get_full_proforma()`, `send_proforma_to_user()`

5. **Модуль 5** (Основной)
   - Название: `keyboards`
   - Описание: Создание интерактивных клавиатур для взаимодействия с пользователем.
   - Функции: `language_selection_keyboard()`, `user_options_keyboard()`

6. **Модуль 6** (Вспомогательный)
   - Название: `constants`
   - Описание: Хранение констант и классов для данных пользователя.
   - Функции: `ORDER_STATUS`, `UserData`

7. **Модуль 7** (Вспомогательный)
   - Название: `translations`
   - Описание: Переводы текстов сообщений и кнопок на различные языки.
   - Функции: `translations`, `button_texts`

### 3.3 Принцип взаимодействия файлов

1. **main.py**: Основной файл, управляющий всеми взаимодействиями с пользователями и запуском бота.

   **Анализ файла main.py**:
   Этот файл является центральным элементом проекта и содержит настройки бота, обработчики команд и логику взаимодействия с пользователями. Основные элементы:

   1. **Импорт библиотек**:
      - Импортируются необходимые библиотеки для работы с Telegram API, базой данных и вспомогательные функции.

   2. **Логирование**:
      - Логирование настраивается для записи в файл `admin_bot.log` с уровнем детализации DEBUG.

   3. **Асинхронные обработчики команд и сообщений**:
      - `start()`: Обрабатывает команду `/start`, инициализирует данные пользователя и предлагает выбрать язык.
      - `button_callback()`: Обрабатывает нажатия кнопок и управляет логикой бота, включая выбор языка и отправку проформ.

   4. **Запуск бота**:
      - Приложение инициализируется и запускается с добавлением соответствующих обработчиков команд и сообщений.

2. **database_helpers.py**: Вспомогательные функции для работы с базой данных.

   **Анализ файла database_helpers.py**:
   Этот файл содержит функции для получения данных пользователя, генерации и отправки проформ, а также обновления статуса заказов в базе данных.

   1. **Функции для работы с базой данных**:
      - `get_user_data()`: Получает данные пользователя по user_id.
      - `get_full_proforma()`: Получает полную информацию о заказе для генерации проформы.
      - `send_proforma_to_user()`: Отправляет проформу пользователю через Telegram.

3. **keyboards.py**: Модуль для создания различных клавиатур.

   **Анализ файла keyboards.py**:
   Этот файл содержит функции для генерации inline-клавиатур, таких как выбор языка и просмотр проформ.

   1. **Функции для генерации клавиатур**:
      - `language_selection_keyboard()`: Генерация клавиатуры для выбора языка.
      - `user_options_keyboard()`: Генерация клавиатуры для взаимодействия с проформой.

# 4. Новые компоненты в версии 2.0

#### 4.1 Добавлены следующие модули

1. **`database_helpers.py`**
   - Назначение: Управление взаимодействием с базой данных и отправкой сообщений пользователям.
   - Особенности: Включает функции для получения и отправки проформ, а также обновления статуса заказов.

2. **`translations.py`**
   - Назначение: Переводы текстов сообщений и кнопок на различные языки.
   - Особенности: Обеспечивает многоязычную поддержку для взаимодействия с пользователями.

# 5. Примечания

- В новой версии 2.0 реализованы базовые функции для управления мероприятиями, включая генерацию и отправку проформ.
- Улучшена структура логирования и обработки ошибок для упрощения отладки и мониторинга работы бота.


# 6. Алфавитный указатель всех функций

### A

- **admin_welcome_message(update: Update)**  
  Отправляет приветственное сообщение администратору и предлагает выбрать язык для взаимодействия. Используется для начала сессии администратора.

- **async def admin_welcome_message(update: Update)**  
  Асинхронная функция, которая отправляет приветственное сообщение администратору и отображает клавиатуру выбора языка.

### C

- **check_date_reserved(date, reserved_dates)**  
  Проверяет, зарезервирована ли конкретная дата в списке уже занятых дат для мероприятий.

- **create_connection(db_file)**  
  Создает соединение с базой данных SQLite по указанному пути.

### D

- **disable_calendar_buttons(reply_markup, selected_date)**  
  Деактивирует кнопки выбора даты в календаре после того, как пользователь выбрал дату мероприятия.

- **disable_language_buttons(reply_markup)**  
  Отключает кнопки выбора языка после того, как пользователь сделал выбор.

### E

- **execute_query(conn, query, params=())**  
  Выполняет SQL-запрос с параметрами и логирует выполнение в базе данных.

- **execute_query_with_retry(conn, query, params=(), max_retries=5)**  
  Выполняет SQL-запрос с повторными попытками в случае блокировки базы данных (например, если база данных занята другим процессом).

### G

- **generate_calendar_keyboard(month_offset=0, language='en')**  
  Генерирует интерактивную клавиатуру для выбора даты мероприятия, отображая календарь. Включает функционал перехода между месяцами.

- **generate_proforma_buttons(proforma_list)**  
  Создает кнопки для просмотра проформ по указанной дате.

- **generate_proforma_buttons_by_date(selected_date)**  
  Генерирует кнопки для отображения проформ по выбранной дате мероприятия.

- **get_db_connection()**  
  Устанавливает и возвращает соединение с базой данных PostgreSQL, используя параметры из переменных окружения.

- **get_dates_with_active_proformas()**  
  Получает даты с активными проформами, у которых статус >= 3 (зарезервировано).

- **get_full_proforma(user_id, session_number)**  
  Получает полную информацию о заказе для пользователя по его ID и номеру сессии. Используется для формирования и отправки проформ пользователю.

- **get_latest_session_number(user_id)**  
  Получает последний номер сессии пользователя по его ID. Обновляет статус проформы после того, как пользователь ее просматривает.

- **get_user_status(user_id)**  
  Получает статус пользователя (администратор или сервисная служба) по его ID из базы данных.

### H

- **handle_date_selection(update, context)**  
  Обрабатывает выбор даты пользователем и отправляет сообщение с подтверждением выбора даты.

- **handle_delete_client_callback(update, context)**  
  Обрабатывает нажатие кнопки удаления клиента из базы данных и отображает календарь для выбора даты.

- **handle_find_client_callback(update, context)**  
  Обрабатывает нажатие кнопки поиска клиента для просмотра проформы и отображает календарь.

- **handle_proforma_button_click(update, context)**  
  Обрабатывает нажатие кнопки для просмотра проформы. Выводит полную информацию о проформе.

### I

- **irina_service_menu()**  
  Создает клавиатуру для взаимодействия с Ириной и сервисной службой. Включает кнопки для поиска, удаления клиента и добавления нового клиента.

### L

- **language_selection_keyboard()**  
  Генерирует клавиатуру для выбора языка пользователем. Поддерживает несколько языков, таких как английский, русский, испанский и другие.

### N

- **null_status(order_id)**  
  Обнуляет статус заказа, присваивая ему значение 0, что указывает на его удаление или отмену.

### S

- **send_proforma_to_user(user_id, session_number, user_data)**  
  Отправляет пользователю информацию о заказе (проформе) через Telegram. Обновляет статус проформы после отправки.

- **service_welcome_message(update: Update)**  
  Приветственное сообщение для службы сервиса с отображением меню действий.

### T

- **to_superscript(num_str)**  
  Преобразует цифры в строке в верхний индекс (суперскрипт), используется для форматирования дат в календаре.

### U

- **user_welcome_message(update: Update, first_name)**  
  Приветствует пользователя и предлагает выбрать язык для дальнейшего взаимодействия. Используется для инициализации сессии пользователя.

- **user_options_keyboard(language, user_id)**  
  Генерирует клавиатуру для взаимодействия с проформами, включая просмотр проформы, отправку сообщения организатору через WhatsApp и переход в галерею Instagram.
